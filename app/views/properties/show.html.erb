<!-- Estate Match 物件詳細画面 -->
<div class="min-h-screen bg-gray-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
    
    <!-- パンくずリスト -->
    <nav class="mb-4 sm:mb-8">
      <ol class="flex items-center space-x-1 sm:space-x-2 text-xs sm:text-sm text-gray-500 overflow-x-auto">
        <li class="flex-shrink-0"><%= link_to "トップ", root_path, class: "hover:text-estate-primary-600" %></li>
        <li class="flex-shrink-0"><span class="mx-1 sm:mx-2">/</span></li>
        <% if request.referer&.include?('/my_properties') || request.referer&.include?('/edit') || @came_from_edit %>
          <li class="flex-shrink-0"><%= link_to "物件管理", my_properties_path, class: "hover:text-estate-primary-600" %></li>
        <% else %>
          <li class="flex-shrink-0"><%= link_to "物件一覧", properties_path, class: "hover:text-estate-primary-600" %></li>
        <% end %>
        <li class="flex-shrink-0"><span class="mx-1 sm:mx-2">/</span></li>
        <li class="text-gray-900 font-medium truncate"><%= @property.title %></li>
      </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-8">
      
      <!-- メイン画像・詳細情報 -->
      <div class="lg:col-span-2">
        
        <!-- 物件画像 -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-4 sm:mb-6">
          <% if @property.images.attached? %>
            <div class="aspect-w-16 aspect-h-9">
              <%= image_tag @property.images.first, 
                    alt: @property.title,
                    class: "w-full h-48 sm:h-64 lg:h-96 object-cover" %>
            </div>
            <!-- サムネイル画像（複数画像の場合） -->
            <% if @property.images.count > 1 %>
              <div class="p-3 sm:p-4 border-t border-gray-200">
                <div class="grid grid-cols-4 sm:grid-cols-6 gap-2">
                  <% @property.images.each_with_index do |image, index| %>
                    <button class="aspect-w-1 aspect-h-1 rounded-md overflow-hidden hover:opacity-75 transition-opacity">
                      <%= image_tag image, 
                            alt: "#{@property.title} - 画像#{index + 1}",
                            class: "w-full h-12 sm:h-16 object-cover" %>
                    </button>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% else %>
            <!-- デフォルト画像 -->
            <div class="w-full h-48 sm:h-64 lg:h-96 bg-gradient-to-br from-estate-primary-100 to-estate-primary-200 flex items-center justify-center">
              <svg class="h-24 w-24 text-estate-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 21l4-4 4 4" />
              </svg>
            </div>
          <% end %>
        </div>

        <!-- 物件詳細情報 -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-4">物件詳細</h2>
          
          <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <% if @property.property_type.present? %>
              <div>
                <dt class="text-sm font-medium text-gray-500">物件種別</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= Property.human_attribute_name("property_type.#{@property.property_type}") %></dd>
              </div>
            <% end %>
            
            <% if @property.building_area.present? %>
              <div>
                <dt class="text-sm font-medium text-gray-500">建物面積</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @property.building_area %>㎡</dd>
              </div>
            <% end %>
            
            <% if @property.land_area.present? %>
              <div>
                <dt class="text-sm font-medium text-gray-500">土地面積</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @property.land_area %>㎡</dd>
              </div>
            <% end %>
            
            <% if @property.rooms.present? %>
              <div>
                <dt class="text-sm font-medium text-gray-500">間取り</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @property.rooms %></dd>
              </div>
            <% end %>
            
            <% if @property.construction_year.present? %>
              <div>
                <dt class="text-sm font-medium text-gray-500">築年</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @property.construction_year %>年</dd>
              </div>
            <% end %>
            
            <% if @property.parking.present? %>
              <div>
                <dt class="text-sm font-medium text-gray-500">駐車場</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @property.parking %></dd>
              </div>
            <% end %>
          </dl>
        </div>

        <!-- 物件説明 -->
        <% if @property.description.present? %>
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mt-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">物件の特徴・詳細</h2>
            <div class="text-gray-700 whitespace-pre-line">
              <%= simple_format(@property.description) %>
            </div>
          </div>
        <% end %>

        <!-- 間取り図 -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mt-6">
          <h2 class="text-xl font-bold text-gray-900 mb-4">間取り図</h2>
          
          <% if @property.floor_plan.attached? %>
            <!-- 間取り図が存在する場合 -->
            <div class="flex justify-center" data-controller="floor-plan-modal">
              <div class="max-w-4xl w-full">
                <img src="<%= @property.floor_plan.url %>"
                     alt="<%= @property.title %> - 間取り図"
                     class="w-full h-auto rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-200 cursor-pointer"
                     data-action="click->floor-plan-modal#open">
              </div>
            </div>
            <p class="text-sm text-gray-500 text-center mt-2">画像をクリックすると拡大表示されます</p>
          <% else %>
            <!-- 間取り図が存在しない場合 -->
            <div class="flex justify-center items-center py-16 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
              <div class="text-center">
                <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                <h3 class="mt-4 text-lg font-medium text-gray-900">間取り図なし</h3>
                <p class="mt-2 text-sm text-gray-500">
                  この物件には間取り図が<br>
                  登録されていません
                </p>
                <% if user_signed_in? && @property.user == current_user %>
                  <div class="mt-4">
                    <%= link_to "間取り図を追加", edit_property_path(@property), 
                          class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-estate-primary-600 bg-estate-primary-100 hover:bg-estate-primary-200 transition-colors duration-200" %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- サイドバー（価格・お問い合わせ情報）-->
      <div class="lg:col-span-1">
        
        <!-- 価格・お問い合わせカード -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 sticky top-8">
          <!-- タイトル -->
          <div class="mb-2">
            <h1 class="text-2xl font-bold text-gray-900"><%= @property.title %></h1>
          </div>
          
          <!-- ステータス -->
          <div class="mb-4">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
              <%= Property.human_attribute_name("status.#{@property.status}") %>
            </span>
          </div>

          <!-- 価格表示 -->
          <div class="mb-6">
            <% if @property.sale_price.present? && @property.rental_price.present? %>
              <!-- 売買・賃貸両方 -->
              <div class="space-y-2">
                <div>
                  <span class="text-sm text-gray-500">売却価格</span>
                  <p class="text-2xl font-bold text-estate-primary-600">
                    <%= number_to_currency(@property.sale_price, unit: "", precision: 0, delimiter: ",") %>万円
                  </p>
                </div>
                <div>
                  <span class="text-sm text-gray-500">賃料</span>
                  <p class="text-xl font-semibold text-estate-secondary-600">
                    <%= number_to_currency(@property.rental_price, unit: "", precision: 0, delimiter: ",") %>円/月
                  </p>
                </div>
              </div>
            <% elsif @property.sale_price.present? %>
              <!-- 売買のみ -->
              <div>
                <span class="text-sm text-gray-500">売却価格</span>
                <p class="text-3xl font-bold text-estate-primary-600">
                  <%= number_to_currency(@property.sale_price, unit: "", precision: 0, delimiter: ",") %>万円
                </p>
              </div>
            <% elsif @property.rental_price.present? %>
              <!-- 賃貸のみ -->
              <div>
                <span class="text-sm text-gray-500">賃料</span>
                <p class="text-3xl font-bold text-estate-secondary-600">
                  <%= number_to_currency(@property.rental_price, unit: "", precision: 0, delimiter: ",") %>円/月
                </p>
              </div>
            <% else %>
              <p class="text-xl text-gray-600">価格相談</p>
            <% end %>
          </div>

          <!-- 所在地 -->
          <div class="mb-6">
            <h3 class="text-sm font-medium text-gray-500 mb-2">所在地</h3>
            <div class="text-gray-900">
              <p><%= [@property.prefecture, @property.city, @property.address].compact.join(' ') %></p>
            </div>
          </div>

          <!-- オーナー情報 -->
          <div class="mb-6 pb-6 border-b border-gray-200">
            <h3 class="text-sm font-medium text-gray-500 mb-2">投稿者</h3>
            <div class="flex items-center">
              <div class="h-10 w-10 bg-estate-primary-100 rounded-full flex items-center justify-center">
                <svg class="h-6 w-6 text-estate-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium text-gray-900">
                  <%= @property.user.email.split('@').first %>
                </p>
                <p class="text-xs text-gray-500">
                  <%= time_ago_in_words(@property.created_at) %>前に投稿
                </p>
              </div>
            </div>
          </div>

          <!-- お問い合わせボタン -->
          <div class="space-y-3">
            <% if user_signed_in? %>
              <% if current_user == @property.user %>
                <!-- 自分の物件の場合 -->
                <div class="w-full bg-gray-100 text-gray-500 px-4 py-3 rounded-md font-medium text-center">
                  💬 自分の物件です
                </div>
              <% else %>
                <%= form_with url: conversations_path, method: :post, local: true, class: "w-full" do |form| %>
                  <%= form.hidden_field :property_id, value: @property.id %>
                  <%= form.submit "💬 お問い合わせする", 
                      class: "w-full bg-estate-primary-600 text-white px-4 py-3 rounded-md font-medium hover:bg-estate-primary-700 transition-colors duration-200 cursor-pointer" %>
                <% end %>
              <% end %>
            <% else %>
              <%= link_to "ログインしてお問い合わせ", new_user_session_path,
                    class: "block w-full text-center bg-estate-primary-600 text-white px-4 py-3 rounded-md font-medium hover:bg-estate-primary-700 transition-colors duration-200" %>
            <% end %>
            
            <!-- お気に入りボタン（購入希望者のみ） -->
            <% if user_signed_in? && current_user.buyer? %>
              <button type="button" 
                      class="w-full px-4 py-3 rounded-md font-medium transition-colors duration-200 border <%= @property.favorited_by?(current_user) ? 'bg-pink-50 border-pink-200 text-pink-700' : 'bg-gray-50 border-gray-200 text-gray-700 hover:bg-pink-50 hover:border-pink-200 hover:text-pink-700' %>"
                      data-controller="favorite"
                      data-favorite-property-id-value="<%= @property.id %>"
                      data-favorite-favorited-value="<%= @property.favorited_by?(current_user) %>"
                      data-action="click->favorite#toggle">
                <div class="flex items-center justify-center space-x-2">
                  <svg class="w-5 h-5" fill="<%= @property.favorited_by?(current_user) ? 'currentColor' : 'none' %>" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                  </svg>
                  <span class="favorite-text">
                    <%= @property.favorited_by?(current_user) ? 'お気に入り済' : 'お気に入りに追加する' %>
                  </span>
                </div>
              </button>
            <% end %>
          </div>

          <!-- タグ表示 -->
          <% if @property.tags.any? %>
            <div class="mt-6 pt-6 border-t border-gray-200">
              <h3 class="text-sm font-medium text-gray-500 mb-3">タグ</h3>
              <div class="flex flex-wrap gap-2">
                <% @property.tags.each do |tag| %>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    <%= tag.name %>
                  </span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- 関連物件 -->
    <div class="mt-12">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">この地域の他の物件</h2>
      <!-- TODO: 関連物件の表示 -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center">
        <p class="text-gray-500">関連物件機能は今後実装予定です</p>
      </div>
    </div>
  </div>

  <!-- 間取り図拡大モーダル -->
  <% if @property.floor_plan.attached? %>
    <div id="floor-plan-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4" data-controller="floor-plan-modal">
      <div class="relative max-w-4xl max-h-full">
        <!-- 閉じるボタン -->
        <button type="button" 
                class="absolute -top-12 right-0 text-white hover:text-gray-300 transition-colors duration-200"
                data-action="click->floor-plan-modal#close">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        
        <!-- 間取り図画像 -->
        <div class="bg-white rounded-lg p-4">
          <img src="<%= @property.floor_plan.url %>"
               alt="<%= @property.title %> - 間取り図（拡大）"
               class="max-w-full max-h-[80vh] object-contain">
        </div>
      </div>
      
      <!-- 背景クリックで閉じる -->
      <div class="absolute inset-0" data-action="click->floor-plan-modal#close"></div>
    </div>
  <% end %>
</div>
