<%= turbo_frame_tag "property_modal_content" do %>
  <div class="p-8">
    <!-- Step Title -->
    <div class="text-center mb-8">
      <h3 class="text-2xl font-bold text-estate-dark-800 mb-2">物件の所在地を教えてください</h3>
      <p class="text-estate-dark-500">物件がある場所の住所を入力してください</p>
    </div>

    <!-- Location Form -->
    <%= form_with url: save_step3_properties_path, method: :post, local: true, 
                  data: { turbo: true }, class: "space-y-6" do |form| %>
      
      <div class="space-y-6">
        <!-- Prefecture -->
        <div>
          <%= form.label :prefecture, "都道府県", class: "block text-lg font-medium text-estate-dark-700 mb-3" %>
          <%= form.select :prefecture, 
                          options_for_select([
                            ['選択してください', ''],
                            ['北海道', '北海道'], ['青森県', '青森県'], ['岩手県', '岩手県'], ['宮城県', '宮城県'], ['秋田県', '秋田県'],
                            ['山形県', '山形県'], ['福島県', '福島県'], ['茨城県', '茨城県'], ['栃木県', '栃木県'], ['群馬県', '群馬県'],
                            ['埼玉県', '埼玉県'], ['千葉県', '千葉県'], ['東京都', '東京都'], ['神奈川県', '神奈川県'], ['新潟県', '新潟県'],
                            ['富山県', '富山県'], ['石川県', '石川県'], ['福井県', '福井県'], ['山梨県', '山梨県'], ['長野県', '長野県'],
                            ['岐阜県', '岐阜県'], ['静岡県', '静岡県'], ['愛知県', '愛知県'], ['三重県', '三重県'], ['滋賀県', '滋賀県'],
                            ['京都府', '京都府'], ['大阪府', '大阪府'], ['兵庫県', '兵庫県'], ['奈良県', '奈良県'], ['和歌山県', '和歌山県'],
                            ['鳥取県', '鳥取県'], ['島根県', '島根県'], ['岡山県', '岡山県'], ['広島県', '広島県'], ['山口県', '山口県'],
                            ['徳島県', '徳島県'], ['香川県', '香川県'], ['愛媛県', '愛媛県'], ['高知県', '高知県'], ['福岡県', '福岡県'],
                            ['佐賀県', '佐賀県'], ['長崎県', '長崎県'], ['熊本県', '熊本県'], ['大分県', '大分県'], ['宮崎県', '宮崎県'],
                            ['鹿児島県', '鹿児島県'], ['沖縄県', '沖縄県']
                          ], step_data&.dig('prefecture')),
                          {},
                          { class: "w-full px-4 py-3 text-lg border-2 border-estate-warm-300 rounded-lg focus:outline-none focus:border-estate-primary-500 focus:ring-2 focus:ring-estate-primary-200 transition-all duration-200",
                            required: true } %>
        </div>

        <!-- City -->
        <div>
          <%= form.label :city, "市区町村", class: "block text-lg font-medium text-estate-dark-700 mb-3" %>
          <%= form.text_field :city, 
                              value: step_data&.dig('city'),
                              placeholder: "例：渋谷区、横浜市青葉区",
                              class: "w-full px-4 py-3 text-lg border-2 border-estate-warm-300 rounded-lg focus:outline-none focus:border-estate-primary-500 focus:ring-2 focus:ring-estate-primary-200 transition-all duration-200",
                              required: true %>
          <p class="mt-2 text-sm text-estate-dark-500">市区町村名を入力してください</p>
        </div>

        <!-- Address -->
        <div>
          <%= form.label :address, "町名・番地", class: "block text-lg font-medium text-estate-dark-700 mb-3" %>
          <%= form.text_field :address, 
                              value: step_data&.dig('address'),
                              placeholder: "例：神南1-12-16、青葉台2-3-4",
                              class: "w-full px-4 py-3 text-lg border-2 border-estate-warm-300 rounded-lg focus:outline-none focus:border-estate-primary-500 focus:ring-2 focus:ring-estate-primary-200 transition-all duration-200",
                              required: true %>
          <p class="mt-2 text-sm text-estate-dark-500">町名と番地を入力してください（詳細な住所は後で追加できます）</p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-between pt-6">
        <button type="button" 
                onclick="goBackToStep2()"
                onmouseover="console.log('Button mouse over')"
                class="bg-estate-warm-300 hover:bg-estate-warm-400 text-estate-dark-700 font-medium px-8 py-3 rounded-lg transition duration-200">
          戻る
        </button>
        
        <%= form.submit "次へ進む", 
                        class: "bg-estate-primary-600 hover:bg-estate-primary-700 text-white font-bold px-8 py-3 rounded-lg transition duration-200" %>
      </div>
    <% end %>
  </div>

  <script>
    // Update progress bar to step 3 immediately
    (function() {
      const progressBar = document.querySelector('[data-property-modal-target="progressBar"]');
      const stepIndicator = document.querySelector('[data-property-modal-target="stepIndicator"]');
      
      if (progressBar) {
        progressBar.style.width = '60%';
        console.log('Updated progress to 60% (Step 3)');
      }
      if (stepIndicator) {
        stepIndicator.textContent = '3 / 5';
      }
    })();

    // Back navigation function
    function goBackToStep2() {
      console.log('Going back to step 2');
      
      fetch('<%= new_step2_properties_path %>', {
        method: 'GET',
        headers: {
          'Accept': 'text/vnd.turbo-stream.html',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.text())
      .then(html => {
        const frame = document.querySelector('turbo-frame[id="property_modal_content"]');
        if (frame) {
          frame.innerHTML = html;
          console.log('Successfully navigated to step 2');
          
          // Update progress bar after navigation
          setTimeout(() => {
            const progressBar = document.querySelector('[data-property-modal-target="progressBar"]');
            const stepIndicator = document.querySelector('[data-property-modal-target="stepIndicator"]');
            
            if (progressBar) {
              progressBar.style.width = '40%';
              console.log('Updated progress to 40% (Back to Step 2)');
            }
            if (stepIndicator) {
              stepIndicator.textContent = '2 / 5';
            }
          }, 100);
        } else {
          console.log('Turbo frame not found');
        }
      })
      .catch(error => {
        console.error('Error navigating to step 2:', error);
      });
    }
  </script>
<% end %>